classdef validate_sim_results < matlab.unittest.TestCase
    properties
        % Default course name (will be overridden per test)
        courseName = '';
    end

    properties(Constant)
        % Map matrix case numbers to course names
        courseList = {...
            'lanechange', ...
            'figure8', ...
            'Zandvoort_clothoid', ...
            'Zandvoort', ...
            'Yuma_clothoid', ...
            'Yuma', ...
            'VIR_clothoid', ...
            'VIR', ...
            'RoadAmerica_clothoid', ...
            'RoadAmerica', ...
            'PikesPeak_clothoid', ...
            'PikesPeak', ...
            'VTTI_VIC'};
    end

    methods(Test)
        function validateSimResults(testCase)
            matrixCase = str2double(getenv('MATRIX_CASE'));
            
            dataPath = fullfile(pwd,'downloaded_results','simdata.mat');  % flat
            if ~exist(dataPath,'file')
                error('simdata.mat not found at %s', dataPath);
            end
            % --- Select course name for this test ---
            testCase.courseName = validate_sim_results.courseList{matrixCase};

            % --- Load the simulation file generated by this matrix job ---
            S = load(dataPath)   %'simdata.mat';
            %if ~exist(simFile,'file')
            %    error('Simulation file %s not found.', simFile);
            %end
            %S = load(simFile);
            sim = S.sim;

            % --- Validate Simulation Results ---
            %test_results = validate_sim_results(sim, testCase.courseName);

            f = 3;
            % --- Define L4 Urban ODD Thresholds ---
            thresholds.max_xterr = 0.25*f;       % meters
            thresholds.max_verr  = 0.50*f;       % m/s
            thresholds.max_jerk  = 2.50*f;       % m/s^3 (Comfort limit)
            thresholds.max_alat  = 3.00*f;       % m/s^2 (Stability limit)
            thresholds.tta_limit = 0.10*f;       % 100ms Time-to-Alert for Jamming

            % --- 1. Basic Motion Calculations ---
            v_error = abs(sim.vdes - sim.vcar);
            max_xt_err = max(abs(sim.xterr));
            max_v_err  = max(v_error);
            max_j_long = max(abs(sim.jlat));
            max_a_lat  = max(abs(sim.alat));

            % --- 2. Advanced Scenario Logic ---
            % Lane Change Detection (High Lateral Velocity or Curvature Change)
            is_lane_change = max(abs(diff(sim.psi))) > 0.05; % Simplified heuristic

            % GPS Jamming Detection (Identify when VC_state exits 'Run Hot' unexpectedly)
            % Assuming fault is injected when wpt_status_change is toggled or simulated
            jamming_status = 'N/A';
            if any(sim.wpt_status_change == 1)
                fault_idx = find(sim.wpt_status_change == 1, 1);
                reaction_idx = find(sim.VC_state(fault_idx:end) ~= 4, 1) + fault_idx - 1;

                if ~isempty(reaction_idx)
                    reaction_time = sim.t(reaction_idx) - sim.t(fault_idx);
                    jamming_pass = reaction_time <= thresholds.tta_limit;
                    jamming_status = sprintf('%.3fs', reaction_time);
                else
                    jamming_pass = false;
                    jamming_status = 'NO REACTION';
                end
            else
                jamming_pass = true; % Test not triggered
            end

            testCase.verifyLessThanOrEqual( ...
            max_xt_err, thresholds.max_xterr, ...
            sprintf('%s: Cross-track error too large', testCase.courseName));

            testCase.verifyLessThanOrEqual( ...
            max_v_err, thresholds.max_verr, ...
            sprintf('%s: Velocity tracking error too large', testCase.courseName));

            testCase.verifyLessThanOrEqual( ...
            max_j_long, thresholds.max_jerk, ...
            sprintf('%s: Longitudinal jerk too high', testCase.courseName));

            testCase.verifyLessThanOrEqual( ...
            max_a_lat, thresholds.max_alat, ...
            sprintf('%s: Lateral acceleration too high', testCase.courseName));

            % --- 3. Evaluate Pass/Fail Matrix ---
            results = {
                'Cross Track Error', max_xt_err, thresholds.max_xterr, max_xt_err <= thresholds.max_xterr;
                'Velocity Tracking', max_v_err,  thresholds.max_verr,  max_v_err <= thresholds.max_verr;
                'Longitudinal Jerk', max_j_long, thresholds.max_jerk,  max_j_long <= thresholds.max_jerk;
                'Lateral Accel',     max_a_lat,  thresholds.max_alat,  max_a_lat <= thresholds.max_alat;
                };

            % Append Scenario Specifics
            if is_lane_change
                results(end+1,:) = {'Lane Change Stability', max_a_lat, thresholds.max_alat, max_a_lat <= thresholds.max_alat};
            end
            if strcmp(jamming_status, 'N/A') == 0
                results(end+1,:) = {'Jamming TTA', reaction_time, thresholds.tta_limit, jamming_pass};
            end

            % --- 4. Display Report ---
            fprintf('\n--- VALIDATION REPORT: %s ---\n', testCase.courseName);
            fprintf('%-25s | %-10s | %-10s | %-8s\n', 'Metric', 'Value', 'Limit', 'Status');
            fprintf('%s\n', repmat('-', 1, 65));

            for i = 1:size(results, 1)
                status = 'FAIL';
                if results{i, 4}, status = 'PASS'; end
                fprintf('%-25s | %-10.3f | %-10.3f | %-8s\n', ...
                    results{i, 1}, results{i, 2}, results{i, 3}, status);
            end

            % --- 5. Final Verdict ---
            if all([results{:, 4}])
                fprintf('\nVERDICT: [SAFE] System meets L4 Requirements.\n');
            else
                fprintf('\nVERDICT: [UNSAFE] Failure detected in safety gate.\n');
            end
            test_results = results;
        end

    end

end